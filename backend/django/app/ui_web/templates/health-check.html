<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="3">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbitrage Bot Health Check Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Gray-100 background */
        }
        .card {
            border-left: 4px solid;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .text-error {
            color: #ef4444; /* Red-500 */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Arbitrage Bot Health Status</h1>
        
        <button id="is-pause-position-sync" disabled
            class="mb-4 bg-gray-400 text-white font-semibold py-2 px-4 rounded transition duration-200">
            Initializing...
        </button>

        <p id="bot-sync-status-display" class="text-lg font-medium">
            Bot sync status: <span class="font-bold {% if pausePositionSync == 'Active' %} text-green-600
            {% else %} text-gray-500 {% endif %}">{{ pausePositionSync }}</span>
        </p>

        <!-- Message/Error Display -->
        <p id="api-message" class="mt-2 h-5 text-sm font-semibold"></p>

        <!-- Price Watch Channel Card -->
        <div class="card bg-white p-6 rounded-xl shadow-lg mb-6 border-blue-500">
            <h2 class="text-xl font-semibold text-blue-700 mb-4">Price Watch Channel</h2>
            <div class="space-y-3 text-gray-700">
                <p class="text-lg">Binance (PAXG): 
                    <span class="font-mono text-blue-600 font-bold ml-2">{{ binanceMarkPrice|floatformat:2 }}</span> 
                </p>
                <p class="text-lg">MT5 (XAU): 
                    <span class="font-mono text-green-600 font-bold ml-2">{{ mt5MarkPrice|floatformat:2 }}</span> 
                </p>
                <p class="text-xl font-bold mt-4">Spread (Gap): 
                    <span class="font-mono ml-2 
                        {% if spread > 0 %} text-green-500 
                        {% else %} text-red-500
                        {% endif %}">
                        {{ spread|floatformat:4 }}
                    </span>
                </p>
            </div>
        </div>

        <!-- Matched Pairs Card -->
        <div class="card bg-white p-6 rounded-xl shadow-lg mb-6 border-yellow-500">
            <h2 class="text-xl font-semibold text-yellow-700 mb-4">Matched Pairs (Current Position)</h2>
            <div class="space-y-3 text-gray-700">
                <p>Status: <span class="font-semibold text-gray-900
                    {% if pairStatus == 'Warning' %} text-red-600
                    {% else %} text-green-600
                    {% endif %}">{{ pairStatus|default:'Idle' }}</span></p>
                <p>Binance: 
                    <span class="font-mono font-medium {% if binanceAction == 'LONG' %} text-green-600
                     {% elif binanceAction == 'SHORT' %} text-red-600 
                     {% else %} text-gray-500 
                     {% endif %}">
                        '{{ binanceAction|default:'N/A' }}'
                    </span> 
                    <span class="font-mono font-bold
                    {% if binanceSize > 0 %} text-green-600
                    {% else %} text-red-600
                    {% endif %}">{{ binanceSize|default:0 }}</span> 
                    PAXG @ <span class="font-mono">{{ binanceMarkPrice|floatformat:2 }}</span>
                </p>
                <p>Mt5: 
                    <span class="font-mono font-medium 
                    {% if mt5Action == 'LONG' %} text-green-600 
                    {% elif mt5Action == 'SHORT' %} text-red-600 
                    {% else %} text-gray-500 
                    {% endif %}">
                        '{{ mt5Action|default:'N/A' }}'
                    </span> 
                    <span class="font-mono font-bold
                    {% if mt5Size > 0 %} text-green-600
                    {% else %} text-red-600
                    {% endif %}">{{ mt5Size|default:0 }}</span> 
                    XAU @ <span class="font-mono">{{ mt5MarkPrice|floatformat:2 }}</span>
                </p>
                <p>PNL (Unrealized): 
                    <span class="font-mono text-lg font-bold 
                    {% if unrealizedBinance >= 0 %} text-green-500 
                        {% else %} text-red-500
                        {% endif %}">
                        {{ unrealizedBinance|default:0.00|floatformat:2 }} USD
                    </span>
                </p>
            </div>
        </div>

        <!-- Summary Card -->
        <div class="card bg-white p-6 rounded-xl shadow-lg border-green-500">
            <h2 class="text-xl font-semibold text-green-700 mb-4">Summary</h2>
            <div class="space-y-3 text-gray-700">
                <p>Total PAXG: <span class="font-mono font-medium 
                    {% if binanceSize > 0 %} text-green-600 
                    {% else %} text-red-600 
                    {% endif %}">{{ binanceSize|default:0 }}</span></p>
                <p>Total XAU Lots: <span class="font-mono font-medium 
                    {% if mt5Size > 0 %} text-green-600 
                    {% else %} text-red-600 
                    {% endif %}">{{ mt5Size|default:0 }}</span></p> 
                <p>Net Expose: <span class="font-mono font-medium text-gray-500">{{ netExpose|default:0 }}</span></p>
            </div>
        </div>
        
    </div>

    <script>
        const API_ENDPOINT = 'https://mt5-django.vatanutanon.me/displays/pause/'; 
        
        // Helper function for CSRF token (จำเป็นสำหรับ Django POST)
        function getCsrfToken() {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.startsWith('csrftoken=')) {
                        cookieValue = decodeURIComponent(cookie.substring(10));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function updateButton(state, message = '') {
            const button = document.getElementById('is-pause-position-sync');
            const messageDisplay = document.getElementById('api-message');

            // Clear previous classes
            button.className = "mb-4 font-semibold py-2 px-4 rounded transition duration-200";
            messageDisplay.textContent = message;
            messageDisplay.classList.remove('text-green-500', 'text-error');

            if (state === 'loading') {
                button.textContent = 'Calling API...';
                button.disabled = true;
                button.classList.add('bg-gray-400', 'text-white', 'opacity-75', 'cursor-not-allowed');
                messageDisplay.textContent = 'Sending request to toggle pause...';
            } else if (state === 'success') {
                button.textContent = 'Toggle pause success!';
                button.disabled = false;
                button.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white');
                messageDisplay.textContent = 'API call successful.';
                messageDisplay.classList.add('text-green-500');
                
                // Revert button text after a delay
                setTimeout(() => updateButton('initial'), 1500);
            } else if (state === 'error') {
                button.textContent = 'Error! Try Again';
                button.disabled = false;
                button.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white');
                messageDisplay.textContent = message || 'API call failed. Check console for details.';
                messageDisplay.classList.add('text-error');
            } else { // 'initial' state
                button.textContent = 'Pause position sync toggle';
                button.disabled = false;
                button.classList.add('hover:bg-blue-500', 'text-blue-700', 'border', 'border-blue-500', 'hover:border-transparent', 'hover:text-white');
            }
        }

        async function callRestAPI() {
            updateButton('loading');
            
            try {
                const csrfToken = getCsrfToken();
                if (!csrfToken) {
                    throw new Error("CSRF token not found. Cannot perform POST request.");
                }

                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken, // ส่ง CSRF Token ไปกับ Header
                        'Content-Type': 'application/json'
                    },
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`HTTP error! Status: ${response.status}. See console.`);
                }
                
                const data = await response.json();
                console.log("API Success Response:", data);
                updateButton('success'); 

            } catch (error) {
                console.error('Error in callRestAPI:', error);
                updateButton('error', error.message);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateButton('initial');
            document.getElementById('is-pause-position-sync').addEventListener('click', callRestAPI);
        });
    </script>
</body>
</html>